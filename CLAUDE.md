# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Punktual is a Next.js 15 web application for generating "Add to Calendar" buttons and links. Users can create calendar events with customizable buttons that work across Google Calendar, Apple Calendar, Outlook, Yahoo, and other platforms. The app includes authentication, event saving, and short link generation.

## Tech Stack

- **Framework**: Next.js 15 with App Router and React 19
- **Language**: TypeScript (with `strict: false` in tsconfig)
- **Styling**: Tailwind CSS + HeroUI component library
- **Database**: Supabase (PostgreSQL)
- **Authentication**: Supabase Auth (email/password + Google OAuth)
- **Analytics**: Google Analytics 4 via GTM
- **Deployment**: Configured for Vercel

## Development Commands

```bash
# Start development server with Turbopack
npm run dev

# Build for production
npm run build

# Run production build
npm start

# Lint code
npm run lint
```

**Note**: ESLint is configured to ignore errors during builds (`ignoreDuringBuilds: true` in [next.config.ts](next.config.ts)).

## Project Structure

```
src/
├── app/                    # Next.js App Router pages and routes
│   ├── api/               # API routes (short links, etc.)
│   ├── create/            # Event creation page (protected)
│   ├── dashboard/         # User dashboard (protected)
│   └── auth/callback/     # OAuth callback handler
├── components/
│   ├── EventCreator/      # Main event creation interface
│   ├── Auth/              # Auth UI (login, signup, ProtectedRoute)
│   ├── Dashboard/         # Dashboard components
│   ├── homepage/          # Marketing page components
│   └── forms/             # Reusable form components
├── contexts/
│   └── EventContext.tsx   # Global state for event and button data
├── hooks/
│   ├── useAuth.tsx        # Supabase authentication hook
│   └── useSaveEvent.ts    # Event persistence hook
├── lib/
│   ├── analytics.js       # Google Analytics tracking utilities
│   ├── logger.ts          # Logging utility
│   └── storage.js         # Browser storage helpers
├── types/
│   └── index.ts           # All TypeScript type definitions
└── utils/
    ├── calendarGenerator.ts  # Generates calendar URLs and ICS files
    ├── shortLinks.ts         # Short link creation helpers
    ├── timeUtils.ts          # Time formatting utilities
    └── timezoneUtils.ts      # Timezone handling
```

## Architecture Patterns

### State Management

**EventContext** ([src/contexts/EventContext.tsx](src/contexts/EventContext.tsx)) is the central state manager for the event creation flow. It manages:
- `eventData`: Event details (title, dates, location, etc.)
- `buttonData`: Button customization (style, colors, platforms)
- `generatedCode`: HTML/CSS output
- `calendarLinks`: Platform-specific URLs
- `savedShortLinks`: Short URLs after saving

**Important**: The context uses memoized callbacks to prevent render loops. When updating state, use the provided `updateEvent()` and `updateButton()` functions, not direct state setters.

### Authentication Flow

Authentication is handled by **useAuth** ([src/hooks/useAuth.tsx](src/hooks/useAuth.tsx)):

1. Auth state is initialized via `onAuthStateChange` listener (not `getSession()` to avoid timeouts)
2. User profiles are automatically created in `user_profiles` table on signup
3. OAuth callback is handled at [/auth/callback](src/app/auth/callback/page.tsx)
4. Protected routes use `<ProtectedRoute>` wrapper from [src/components/Auth/ProtectedRoute.tsx](src/components/Auth/ProtectedRoute.tsx)

**OAuth Setup**: Google OAuth redirects to `/auth/callback` with `access_type: 'offline'` and `prompt: 'consent'`.

**Key Auth Functions**:
- `signUp(email, password, options)` - Email/password signup
- `signIn(email, password)` - Email/password login
- `signInWithGoogle()` - Google OAuth
- `signOut()` - Logout and redirect to home
- `getUserProfile()` - Fetch user profile from `user_profiles` table

### Calendar Link Generation

Calendar URLs are generated by **calendarGenerator.ts** ([src/utils/calendarGenerator.ts](src/utils/calendarGenerator.ts)):

- `generateCalendarLinks(eventData)` - Returns platform-specific URLs
- `generateCalendarCode(eventData, buttonData, outputType)` - Returns HTML/CSS/JS code
- Each platform (Google, Apple, Outlook, Yahoo) has different URL formats
- Apple Calendar uses ICS file format (data URI with `text/calendar`)
- All dates are formatted in ISO 8601 without separators (e.g., `20250101T100000`)

### Short Links System

Short links are created via [/api/create-short-link](src/app/api/create-short-link/route.ts) and stored in Supabase `short_links` table:

- Short IDs are 8-character alphanumeric (e.g., `AB12CD34`)
- Redirect route: [/eventid/[shortId]](src/app/eventid/[shortId]/route.ts)
- Track click counts in database
- Helper functions in [src/utils/shortLinks.ts](src/utils/shortLinks.ts)

### Event Persistence

Events are saved using **useSaveEvent** hook ([src/hooks/useSaveEvent.ts](src/hooks/useSaveEvent.ts)):

1. Validates user is authenticated
2. Saves event to `events` table
3. Generates calendar links
4. Creates short links for all platforms
5. Returns `eventId` and `shortLinks`

**Note**: Usage tracking code exists but RPC functions are not yet implemented (see TODOs in the file).

## Database Schema

### Key Tables

- **`user_profiles`**: Extended user data (id, user_id, email, full_name, avatar_url, plan)
- **`events`**: Saved calendar events (user_id, title, description, location, dates, timezone, share_id)
- **`short_links`**: URL shortener (short_id, original_url, click_count, user_id, event_title)

### Migrations

Supabase migrations are in [supabase/migrations/](supabase/migrations/).

## Important Type Definitions

All types are centralized in [src/types/index.ts](src/types/index.ts):

- `EventData`: Event properties (title, dates, recurrence, etc.)
- `ButtonData`: Button styling and platform selection
- `CalendarLinks`: Object mapping platform names to URLs
- `EventContextType`: Context API shape
- `AuthContextType`: Auth hook API shape
- `UserProfile`: Database user profile shape
- `ShortLink`: Short link database record

## Styling System

- **Primary color**: Emerald (#10b981) - configured in [tailwind.config.ts](tailwind.config.ts)
- **Component library**: HeroUI with custom theme
- **Dark mode**: Class-based (`darkMode: "class"`)
- **Font**: Nunito (loaded via CSS variables)
- **Responsive**: Mobile-first design with HeroUI responsive utilities

## Analytics

Google Analytics events are tracked via [src/lib/analytics.js](src/lib/analytics.js):

- `trackSignUp(method)` - User signup (email or google)
- `trackCalendarLinkClick(provider, placement)` - Calendar link clicks
- `trackCalendarEventCreated(context)` - Event creation
- `trackTrafficSource()` - UTM parameter tracking
- `trackConversion(type, value)` - General conversions

Events are pushed to `window.dataLayer` for GTM.

## Path Aliases

TypeScript paths are configured with `@/*` mapping to `./src/*` in [tsconfig.json](tsconfig.json).

Example: `import { useAuth } from '@/hooks/useAuth'`

## Known Issues & TODOs

1. **Usage Tracking**: Code references `usage_tracking` table and RPC functions that don't exist yet (see [src/hooks/useSaveEvent.ts](src/hooks/useSaveEvent.ts))
2. **TypeScript Strict Mode**: Currently disabled (`strict: false`) - consider enabling incrementally
3. **Auth Note**: Recent update (2025-08-21) restored authentication to working state after issues

## Working with This Codebase

### Adding New Calendar Platform

1. Add platform to `CalendarLinks` type in [src/types/index.ts](src/types/index.ts)
2. Add URL generation logic in [src/utils/calendarGenerator.ts](src/utils/calendarGenerator.ts)
3. Update `selectedPlatforms` in `ButtonData` type
4. Add platform UI in EventCreator components

### Adding New Page

1. Create page in `src/app/[route]/page.tsx`
2. For protected pages, wrap content in `<ProtectedRoute>`
3. Add navigation links in header/footer components

### Modifying Event Data Structure

1. Update `EventData` type in [src/types/index.ts](src/types/index.ts)
2. Update EventContext default values in [src/contexts/EventContext.tsx](src/contexts/EventContext.tsx)
3. Update database schema if persisting new fields
4. Update form components in [src/components/EventCreator/](src/components/EventCreator/)

### Testing Calendar Links

Use the DynamicPreview component ([src/components/EventCreator/DynamicPreview.tsx](src/components/EventCreator/DynamicPreview.tsx)) to test generated links before deploying.

## Environment Variables

Required environment variables (reference `.env.local` or deployment platform):

- `NEXT_PUBLIC_SUPABASE_URL` - Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase anonymous key
- `NEXT_PUBLIC_GA_MEASUREMENT_ID` - Google Analytics measurement ID
- `NEXT_PUBLIC_BASE_URL` - Base URL for short links (e.g., `https://punktual.co`)

## Git Workflow

- Main branch: `main`
- ESLint errors don't block builds
- Commit messages follow conventional style (see recent commits)
